<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Myanmar Agro-Advisories</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      /* background: #f0f2f5; */ /* Old background */
      background-color: #f5f5dc; /* Beige/earthy background */
      background-image: url('placeholder-for-agriculture-background.jpg'); /* Add a relevant background image URL here */
      background-size: cover;
      background-position: center;
      background-attachment: fixed; /* Optional: keeps background fixed during scroll */
      padding: 20px;
      color: #333;
    }
    h1 {
        /* color: #1a73e8; */ /* Old Google Blue */
        color: #228B22; /* Forest Green */
        text-align: center;
        margin-bottom: 30px;
        background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent white background for readability */
        padding: 10px 0;
        border-radius: 5px;
    }
    #search-input {
        width: calc(100% - 22px); /* Account for padding */
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1em;
    }
    .card {
      background: #fff;
      margin-bottom: 15px;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      transition: all 0.3s cubic-bezier(.25,.8,.25,1);
    }
    .card:hover {
        box-shadow: 0 5px 10px rgba(0,0,0,0.20), 0 3px 3px rgba(0,0,0,0.15);
    }
    summary {
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      /* color: #1a73e8; */ /* Old Google Blue */
      color: #556B2F; /* Dark Olive Green */
    }
    details[open] summary {
        margin-bottom: 10px;
    }
    ul {
      margin: 0;
      padding-left: 25px;
      list-style: disc;
      line-height: 1.6;
    }
    li {
        margin-bottom: 5px;
    }
    .no-results {
        text-align: center;
        color: #777;
        font-style: italic;
        margin-top: 20px;
    }
    #suggestions-list {
        border: 1px solid #ccc;
        border-top: none;
        max-height: 150px;
        overflow-y: auto;
        background-color: #fff;
        position: absolute;
        width: calc(100% - 42px); /* Match search input width */
        z-index: 1000;
        border-radius: 0 0 4px 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .suggestion-item {
        padding: 8px 10px;
        cursor: pointer;
    }
    .suggestion-item:hover {
        background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>Myanmar Agricultural Pest & Disease Advisories</h1>
  <!-- Filter dropdowns removed -->
  <div style="position: relative;">
    <input type="text" id="search-input" placeholder="Search articles by title or content..." autocomplete="off">
    <div id="suggestions-list"></div>
  </div>
  <div id="article-counts" style="margin: 10px 0; font-weight: bold;"></div>
  <div id="overview-counts" style="margin: 10px 0; font-size: 0.9em; color: #555;"></div> <!-- Added for overview counts -->
  <div id="container">Loading articles...</div>

  <script>
    const container = document.getElementById("container");
    const searchInput = document.getElementById("search-input");
    const suggestionsList = document.getElementById("suggestions-list");
    // const cropFilter = document.getElementById("crop-filter"); // Removed
    // const categoryFilter = document.getElementById("category-filter"); // Removed
    let allArticlesData = []; // Store all loaded article data
    let debounceTimer;
    let currentCropFilter = ''; // State for current crop filter
    let currentCategoryFilter = ''; // State for current category filter

    async function loadArticle(index) {
      try {
        const response = await fetch(`data/article${index}.json`);
        if (!response.ok) {
            console.warn(`Failed to load article${index}.json: ${response.statusText}`);
            return null; // Indicate failure
        }
        const data = await response.json();
        // Add the index to the data for reference if needed later
        data.id = index;
        return data;
      } catch (err) {
          console.error(`Error fetching or parsing article${index}.json`, err);
          return null; // Indicate failure
      }
    }

    function renderArticles(articlesToRender) {
        container.innerHTML = ""; // Clear previous content
        if (articlesToRender.length === 0) {
            container.innerHTML = '<p class="no-results">No articles match your search.</p>';
            return;
        }

        articlesToRender.forEach(data => {
            if (!data) return; // Skip if data is null (failed load)

            const card = document.createElement("div");
            card.className = "card";

            // Extract tags
            const tagsHtml = `
                <div style="margin-bottom: 10px; font-size: 0.9em; color: #555;">
                    <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 4px; margin-right: 5px;">Crop: ${data.crop || 'N/A'}</span>
                    <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 4px; margin-right: 5px;">Category: ${data.category || 'N/A'}</span>
                    <span style="background-color: #e0e0e0; padding: 2px 6px; border-radius: 4px;">Source: ${data.source || 'N/A'}</span>
                </div>
            `;

            // Use source (without .docx) as the main title, fallback to crop or ID
            let mainTitle = `Article ${data.id}`; // Default title
            if (data.source) {
                mainTitle = data.source.replace(/\.docx$/i, ''); // Remove .docx extension, case-insensitive
            } else if (data.crop) {
                mainTitle = `${data.crop} Information`;
            }
            // const mainTitle = data.crop ? `${data.crop} Information` : `Article ${data.id}`;
            let contentHtml = '';

            if (data.entries && Array.isArray(data.entries)) {
                data.entries.forEach(entry => {
                    // Add entry title as a heading
                    if (entry.title) {
                        contentHtml += `<h4 style="margin-top: 15px; margin-bottom: 5px; color: #333;">${entry.title}</h4>`;
                    }
                    // Add entry content as a bulleted list
                    if (entry.content && Array.isArray(entry.content)) {
                        contentHtml += '<ul>';
                        entry.content.forEach(item => {
                            contentHtml += `<li>${item}</li>`;
                        });
                        contentHtml += '</ul>';
                    }
                });
            }

            card.innerHTML = `
                <details>
                <summary>${mainTitle}</summary>
                ${tagsHtml}
                <div>
                    ${contentHtml}
                </div>
                </details>
            `;
            // Ensure details are closed by default if needed, or manage state
            // const detailsElement = card.querySelector('details');
            // detailsElement.removeAttribute('open');
            container.appendChild(card);
        });
    }

    function updateSuggestions(searchTerm) {
        suggestionsList.innerHTML = ''; // Clear previous suggestions
        if (!searchTerm) {
            suggestionsList.style.display = 'none';
            return;
        }

        const lowerSearchTerm = searchTerm.toLowerCase();
        const matchingTitles = allArticlesData
            .map(data => {
                if (!data || !data.entries || !Array.isArray(data.entries)) return null;
                // Find the first title in the entries, default if none
                const firstEntry = data.entries[0];
                const title = firstEntry && firstEntry.title ? firstEntry.title : `Article ${data.id}`;
                return { title: title, data: data }; // Return object with title and original data
            })
            .filter(item => item && item.title.toLowerCase().includes(lowerSearchTerm))
            .slice(0, 10); // Limit suggestions

        if (matchingTitles.length > 0) {
            matchingTitles.forEach(item => {
                const div = document.createElement('div');
                div.textContent = item.title;
                div.className = 'suggestion-item';
                div.onclick = () => {
                    searchInput.value = item.title; // Set input to clicked suggestion
                    suggestionsList.innerHTML = ''; // Clear suggestions
                    suggestionsList.style.display = 'none';
                    filterArticles(); // Trigger search with the selected title
                };
                suggestionsList.appendChild(div);
            });
            suggestionsList.style.display = 'block';
        } else {
            suggestionsList.style.display = 'none';
        }
    }

    function filterArticles() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        // Use state variables for filters instead of dropdown values
        const selectedCrop = currentCropFilter;
        const selectedCategory = currentCategoryFilter;

        const filteredArticles = allArticlesData.filter(data => {
            if (!data) return false;

            // Filter by crop
            const cropMatch = !selectedCrop || (data.crop && data.crop === selectedCrop);
            if (!cropMatch) return false;

            // Filter by category
            const categoryMatch = !selectedCategory || (data.category && data.category === selectedCategory);
            if (!categoryMatch) return false;

            // Filter by search term (if provided)
            if (searchTerm) {
                if (!data.entries || !Array.isArray(data.entries)) return false;
                const searchContentMatch = data.entries.some(entry => {
                    const titleMatch = entry.title && entry.title.toLowerCase().includes(searchTerm);
                    const contentMatch = entry.content && Array.isArray(entry.content) &&
                                       entry.content.join(" ").toLowerCase().includes(searchTerm);
                    return titleMatch || contentMatch;
                });
                // Also check the main title (source derived)
                let mainTitle = data.source ? data.source.replace(/\.docx$/i, '') : `Article ${data.id}`;
                const mainTitleMatch = mainTitle.toLowerCase().includes(searchTerm);

                return searchContentMatch || mainTitleMatch;
            }

            return true; // Pass if filters match and no search term
        });

        // Update the counts display
        const countsDiv = document.getElementById('article-counts');
        countsDiv.textContent = `Showing ${filteredArticles.length} of ${allArticlesData.length} articles`;

        renderArticles(filteredArticles);
    }

    async function loadAllArticles() {
      const articleCount = 43; // Assuming 43 articles based on previous context
      container.innerHTML = "Loading articles...";
      allArticlesData = []; // Reset data
      const promises = [];

      for (let i = 1; i <= articleCount; i++) {
        promises.push(loadArticle(i));
      }

      // Wait for all fetch requests to complete
      const results = await Promise.all(promises);
      allArticlesData = results.filter(data => data !== null); // Filter out failed loads

      displayOverviewCounts(); // Calculate and display overview counts
      renderArticles(allArticlesData); // Initial render of all articles
      // populateFilters(); // Removed

      // Add event listeners after data is loaded
      searchInput.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          const currentSearchTerm = searchInput.value;
          updateSuggestions(currentSearchTerm); // Update suggestions immediately
          // Debounce the full article filtering
          debounceTimer = setTimeout(() => {
              filterArticles();
          }, 300); // Adjust debounce time as needed
      });

      // cropFilter.addEventListener('change', filterArticles); // Removed
      // categoryFilter.addEventListener('change', filterArticles); // Removed

      // Add listener for clicks on overview counts
      document.getElementById('overview-counts').addEventListener('click', (event) => {
          if (event.target.tagName === 'SPAN' && event.target.dataset.filterType) {
              const filterType = event.target.dataset.filterType;
              const filterValue = event.target.dataset.filterValue;

              // Toggle behavior: If clicking the active filter, clear it
              if (filterType === 'category') {
                  currentCategoryFilter = currentCategoryFilter === filterValue ? '' : filterValue;
                  // Optionally reset the other filter or keep it
                  // currentCropFilter = ''; // Uncomment to reset crop filter when category is clicked
              } else if (filterType === 'crop') {
                  currentCropFilter = currentCropFilter === filterValue ? '' : filterValue;
                  // Optionally reset the other filter or keep it
                  // currentCategoryFilter = ''; // Uncomment to reset category filter when crop is clicked
              } else if (filterType === 'all') {
                  currentCategoryFilter = '';
                  currentCropFilter = '';
              }
              filterArticles(); // Re-filter articles based on the new selection
              displayOverviewCounts(); // Update overview to highlight selection
          }
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', (event) => {
          if (!searchInput.contains(event.target) && !suggestionsList.contains(event.target)) {
              suggestionsList.style.display = 'none';
          }
      });
    }

    function displayOverviewCounts() {
        const categoryCounts = {};
        const cropCounts = {};

        allArticlesData.forEach(data => {
            if (data) {
                if (data.category) {
                    categoryCounts[data.category] = (categoryCounts[data.category] || 0) + 1;
                }
                if (data.crop) {
                    cropCounts[data.crop] = (cropCounts[data.crop] || 0) + 1;
                }
            }
        });

        const overviewDiv = document.getElementById('overview-counts');
        const allActive = !currentCategoryFilter && !currentCropFilter;
        const allStyle = allActive ? 'font-weight: bold; background-color: #ffff99;' : 'cursor: pointer; text-decoration: underline; color: blue;';
        let overviewHtml = `<strong>Overview:</strong> <span class="filter-link" data-filter-type="all" data-filter-value="" style="${allStyle} margin-right: 5px;">All (${allArticlesData.length})</span> | `;

        // Categories
        if (Object.keys(categoryCounts).length > 0) {
            overviewHtml += 'Categories: ';
            overviewHtml += Object.entries(categoryCounts).map(([key, value]) => {
                const isActive = currentCategoryFilter === key;
                const style = isActive ? 'font-weight: bold; background-color: #ffff99;' : 'cursor: pointer; text-decoration: underline; color: blue;';
                return `<span class="filter-link" data-filter-type="category" data-filter-value="${key}" style="${style} margin-right: 5px;">${key} (${value})</span>`;
            }).join(' ');
        } else {
            overviewHtml += 'No categories found.';
        }

        overviewHtml += ' | ';

        // Crops
        if (Object.keys(cropCounts).length > 0) {
            overviewHtml += 'Crops: ';
            overviewHtml += Object.entries(cropCounts).map(([key, value]) => {
                const isActive = currentCropFilter === key;
                const style = isActive ? 'font-weight: bold; background-color: #ffff99;' : 'cursor: pointer; text-decoration: underline; color: blue;';
                return `<span class="filter-link" data-filter-type="crop" data-filter-value="${key}" style="${style} margin-right: 5px;">${key} (${value})</span>`;
            }).join(' ');
        } else {
            overviewHtml += 'No crops found.';
        }

        overviewDiv.innerHTML = overviewHtml;
    }

    // function populateFilters() { ... } // Removed function

    async function loadAllArticles() {
      const articleCount = 43; // Assuming 43 articles based on previous context
      container.innerHTML = "Loading articles...";
      allArticlesData = []; // Reset data
      const promises = [];

      for (let i = 1; i <= articleCount; i++) {
        promises.push(loadArticle(i));
      }

      // Wait for all fetch requests to complete
      const results = await Promise.all(promises);
      allArticlesData = results.filter(data => data !== null); // Filter out failed loads

      displayOverviewCounts(); // Calculate and display overview counts
      renderArticles(allArticlesData); // Initial render of all articles
      // populateFilters(); // Removed

      // Add event listeners after data is loaded
      searchInput.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          const currentSearchTerm = searchInput.value;
          // Update suggestions immediately
          updateSuggestions(currentSearchTerm);
          // Debounce the full article filtering
          debounceTimer = setTimeout(() => {
              filterArticles();
          }, 300); // Adjust debounce time as needed
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', (event) => {
          if (!searchInput.contains(event.target) && !suggestionsList.contains(event.target)) {
              suggestionsList.style.display = 'none';
          }
      });
    }

    loadAllArticles();
  </script>
</body>
</html>
